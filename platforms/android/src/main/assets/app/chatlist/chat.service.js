"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var firebase = require("nativescript-plugin-firebase");
var Observable_1 = require("rxjs/Observable");
var BehaviorSubject_1 = require("rxjs/BehaviorSubject");
var Subject_1 = require("rxjs/Subject");
require("rxjs/add/operator/share");
var chat_model_1 = require("./chat.model");
var services_1 = require("../services");
var ChatService = (function () {
    function ChatService(ngZone) {
        this.ngZone = ngZone;
        this._chatlist = [];
        this._chatlistobservable = new BehaviorSubject_1.BehaviorSubject([]);
        this._chatlistoUpdate = new Subject_1.Subject();
    }
    ChatService.prototype.cleanemail = function (email) {
        if (!email)
            return "";
        var charactercount = email.length;
        var cleanedstring = "";
        var i;
        for (i = 0; i < charactercount; i++) {
            if (email.charAt(i) == ".")
                continue;
            if (email.charAt(i) == "@")
                continue;
            cleanedstring += email.charAt(i);
        }
        return cleanedstring;
    };
    ChatService.prototype.getsessionid = function (emailid1, emailid2) {
        emailid1 = this.cleanemail(emailid1);
        emailid2 = this.cleanemail(emailid2);
        var sessionpath = emailid1 < emailid2 ? emailid1 + emailid2 : emailid2 + emailid1;
        return sessionpath;
    };
    ChatService.prototype.savemessage = function (from, to, message) {
        console.log('saving message from ' + from + ' To ' + to);
        var sessionid = this.getsessionid(from, to);
        var path = "/Messages/" + sessionid;
        var msgstatus = chat_model_1.MessageStatus.Pending;
        return firebase.push(path, { "sessionid": sessionid, "sentby": from, "recievedby": to, "message": message, "msgstatus": msgstatus, "datetime": 0 - Date.now(), updateTs: firebase.ServerValue.TIMESTAMP }).then(function (result) {
            console.log('message saved ' + JSON.stringify(result));
            return JSON.stringify(result);
        }, function (errorMessage) {
            console.log(errorMessage);
        });
    };
    ChatService.prototype.getchatListBetween = function (user1, user2) {
        var _this = this;
        return new Observable_1.Observable(function (observer) {
            var sessionid = _this.getsessionid(user1, user2);
            var path = "/Messages/" + sessionid;
            var onValueEvent = function (snapshot) {
                _this.ngZone.run(function () {
                    var results = _this.handleChatSnapshot(snapshot.value);
                    observer.next(results);
                });
            };
            firebase.addValueEventListener(onValueEvent, "" + path);
        }).share();
    };
    ChatService.prototype.handleChatSnapshot = function (data) {
        this._chatlist = [];
        if (data) {
            for (var id in data) {
                var result = Object.assign({ id: id }, data[id]);
                this._chatlist.push(result);
            }
            this._chatlist.sort(function (a, b) {
                if (a.datetime > b.datetime)
                    return -1;
                if (a.datetime < b.datetime)
                    return 1;
                return 0;
            });
            this._chatlistobservable.next(this._chatlist.slice());
        }
        return this._chatlist;
    };
    ChatService.prototype.filterUnread = function (email, chatlist) {
        return chatlist.filter(function (chat) { return (chat.recievedby == email && chat.msgstatus == chat_model_1.MessageStatus.RecievedAtServer); });
    };
    ChatService.prototype.markmessagesasread = function (chatlist) {
        console.log("chat list count: " + chatlist.length);
        var chatid;
        var recievedAtServer = chat_model_1.MessageStatus.RecievedAtServer;
        console.log("status: " + recievedAtServer);
        var containerobserv;
        var unreadchatlist = chatlist.filter(function (chat) { return (chat.recievedby == services_1.BackendService.email && chat.msgstatus == recievedAtServer); });
        console.log("Filetered chat list count: " + unreadchatlist.length);
        var updateobj = {};
        for (chatid in unreadchatlist) {
            var chat = chatlist[chatid];
            var path = "/Messages/" + chat.sessionid + "/" + chat.id + "/msgstatus";
            updateobj[path] = chat_model_1.MessageStatus.DeliveredToPhone;
        }
        return firebase.update('', updateobj).then(function (res) {
            return "Record Saved In Firebase";
        }).catch(function (errorMessage) {
            console.log(errorMessage);
        });
    };
    ChatService.prototype.updatemessagestatus = function (chat) {
        var recievedAtServer = chat_model_1.MessageStatus.RecievedAtServer;
        console.log("status: " + recievedAtServer);
        var updateobj = {};
        var path = "/Messages/" + chat.sessionid + "/" + chat.id + "/msgstatus";
        console.log("Path To Doc " + path);
        updateobj[path] = chat_model_1.MessageStatus.DeliveredToPhone;
        return firebase.update('', updateobj).then(function (res) {
            return "Record Saved In Firebase";
        }).catch(function (errorMessage) {
            console.log(errorMessage);
        });
    };
    ChatService.prototype.getunreadmessages = function (deviceowner, remoteuser) {
        var _this = this;
        var sessionid = this.getsessionid(deviceowner, remoteuser);
        var path = "/Messages/" + sessionid;
        var onQueryEvent = function (result) {
            if (!result.error && result.value) {
                console.log("Event type: " + result.type);
                console.log("Key: " + result.key);
                console.log("Value: " + JSON.stringify(result.value));
                var chat = result.value;
                if (chat.recievedby == deviceowner && chat.msgstatus == chat_model_1.MessageStatus.RecievedAtServer) {
                    console.log("Message Fired: " + chat.message);
                    _this._chatlistoUpdate.next(chat);
                }
            }
        };
        return firebase.query(onQueryEvent, path, {
            singleEvent: false,
            orderBy: {
                type: firebase.QueryOrderByType.KEY
            },
        }).then(function (result) {
            return result;
        });
    };
    ChatService.prototype.getchatListBetween1 = function (deviceowner, remoteuser) {
        var _this = this;
        return new Observable_1.Observable(function (observer) {
            var sessionid = _this.getsessionid(deviceowner, remoteuser);
            var path = "/Messages/" + sessionid;
            var onQueryEvent = function (result) {
                if (!result.error && result.value) {
                    console.log("Event type: " + result.type);
                    console.log("Key: " + result.key);
                    console.log("Value: " + JSON.stringify(result.value));
                    var chat = result.value;
                    if (chat.recievedby == deviceowner && chat.msgstatus == chat_model_1.MessageStatus.RecievedAtServer) {
                        console.log("Message Fired: " + chat.message);
                        _this.ngZone.run(function () {
                            observer.next(chat);
                        });
                    }
                }
            };
            firebase.query(onQueryEvent, path, {
                singleEvent: false,
                orderBy: {
                    type: firebase.QueryOrderByType.KEY
                },
            }).then(function (result) {
            });
        }).share();
    };
    return ChatService;
}());
ChatService = __decorate([
    core_1.Injectable(),
    __metadata("design:paramtypes", [core_1.NgZone])
], ChatService);
exports.ChatService = ChatService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hhdC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY2hhdC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUEsc0NBQTJEO0FBQzNELHVEQUEwRDtBQUMxRCw4Q0FBNkM7QUFDN0Msd0RBQXVEO0FBQ3ZELHdDQUF1QztBQUV2QyxtQ0FBaUM7QUFDakMsMkNBQTZDO0FBRTdDLHdDQUE2QztBQUk3QyxJQUFhLFdBQVc7SUFDcEIscUJBQ1ksTUFBYztRQUFkLFdBQU0sR0FBTixNQUFNLENBQVE7UUFHbEIsY0FBUyxHQUFnQixFQUFFLENBQUM7UUFDcEMsd0JBQW1CLEdBQWlDLElBQUksaUNBQWUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUM1RSxxQkFBZ0IsR0FBa0IsSUFBSSxpQkFBTyxFQUFRLENBQUM7SUFKbEQsQ0FBQztJQUtMLGdDQUFVLEdBQVYsVUFBVyxLQUFhO1FBQ3BCLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDO1lBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQztRQUN0QixJQUFJLGNBQWMsR0FBVyxLQUFLLENBQUMsTUFBTSxDQUFDO1FBQzFDLElBQUksYUFBYSxHQUFXLEVBQUUsQ0FBQztRQUFDLElBQUksQ0FBUyxDQUFDO1FBQzlDLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLGNBQWMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1lBQ2xDLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLElBQUksR0FBRyxDQUFDO2dCQUFDLFFBQVEsQ0FBQztZQUNyQyxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLEdBQUcsQ0FBQztnQkFBQyxRQUFRLENBQUM7WUFFckMsYUFBYSxJQUFJLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDckMsQ0FBQztRQUVELE1B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R0FBRyxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7b0JBQ2xDLE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7b0JBQ3RELElBQUksSUFBSSxHQUFTLE1BQU0sQ0FBQyxLQUFLLENBQUM7b0JBQzlCLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLElBQUksV0FBVyxJQUFJLElBQUksQ0FBQyxTQUFTLElBQVksMEJBQWEsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUM7d0JBQzdGLE9BQU8sQ0FBQyxHQUFHLENBQUMsaUJBQWlCLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO3dCQUU5QyxLQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQzs0QkFFWixRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO3dCQUN4QixDQUFDLENBQUMsQ0FBQztvQkFDUCxDQUFDO2dCQUNMLENBQUM7WUFDTCxDQUFDLENBQUM7WUFDRixRQUFRLENBQUMsS0FBSyxDQUNWLFlBQVksRUFDWixJQUFJLEVBQ0o7Z0JBRUksV0FBVyxFQUFFLEtBQUs7Z0JBRWxCLE9BQU8sRUFBRTtvQkFDTCxJQUFJLEVBQUUsUUFBUSxDQUFDLGdCQUFnQixDQUFDLEdBQUc7aUJBRXRDO2FBRUosQ0FDSixDQUFDLElBQUksQ0FBQyxVQUFBLE1BQU07WUFHYixDQUFDLENBQUMsQ0FBQztRQUVQLENBQUMsQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQ2YsQ0FBQztJQUVMLGtCQUFDO0FBQUQsQ0FBQyxBQTVORCxJQTROQztBQTVOWSxXQUFXO0lBRHZCLGlCQUFVLEVBQUU7cUNBR1csYUFBTTtHQUZqQixXQUFXLENBNE52QjtBQTVOWSxrQ0FBVyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdCwgTmdab25lIH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcclxuaW1wb3J0IGZpcmViYXNlID0gcmVxdWlyZShcIm5hdGl2ZXNjcmlwdC1wbHVnaW4tZmlyZWJhc2VcIik7XHJcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzL09ic2VydmFibGUnO1xyXG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QgfSBmcm9tICdyeGpzL0JlaGF2aW9yU3ViamVjdCc7XHJcbmltcG9ydCB7IFN1YmplY3QgfSBmcm9tICdyeGpzL1N1YmplY3QnO1xyXG5cclxuaW1wb3J0ICdyeGpzL2FkZC9vcGVyYXRvci9zaGFyZSc7XHJcbmltcG9ydCB7IE1lc3NhZ2VTdGF0dXMgfSBmcm9tIFwiLi9jaGF0Lm1vZGVsXCI7XHJcbmltcG9ydCB7IENoYXQgfSBmcm9tIFwiLi9jaGF0Lm1vZGVsXCI7XHJcbmltcG9ydCB7IEJhY2tlbmRTZXJ2aWNlIH0gZnJvbSBcIi4uL3NlcnZpY2VzXCI7XHJcblxyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgQ2hhdFNlcnZpY2Uge1xyXG4gICAgY29uc3RydWN0b3IoXHJcbiAgICAgICAgcHJpdmF0ZSBuZ1pvbmU6IE5nWm9uZVxyXG4gICAgKSB7IH1cclxuXHJcbiAgICBwcml2YXRlIF9jaGF0bGlzdDogQXJyYXk8Q2hhdD4gPSBbXTtcclxuICAgIF9jaGF0bGlzdG9ic2VydmFibGU6IEJlaGF2aW9yU3ViamVjdDxBcnJheTxDaGF0Pj4gPSBuZXcgQmVoYXZpb3JTdWJqZWN0KFtdKTtcclxuICAgIF9jaGF0bGlzdG9VcGRhdGU6IFN1YmplY3Q8Q2hhdD4gPSBuZXcgU3ViamVjdDxDaGF0PigpO1xyXG4gICAgY2xlYW5lbWFpbChlbWFpbDogc3RyaW5nKSB7XHJcbiAgICAgICAgaWYgKCFlbWFpbCkgcmV0dXJuIFwiXCI7XHJcbiAgICAgICAgdmFyIGNoYXJhY3RlcmNvdW50OiBudW1iZXIgPSBlbWFpbC5sZW5ndGg7XHJcbiAgICAgICAgdmFyIGNsZWFuZWRzdHJpbmc6IHN0cmluZyA9IFwiXCI7IHZhciBpOiBudW1iZXI7XHJcbiAgICAgICAgZm9yIChpID0gMDsgaSA8IGNoYXJhY3RlcmNvdW50OyBpKyspIHtcclxuICAgICAgICAgICAgaWYgKGVtYWlsLmNoYXJBdChpKSA9PSBcIi5cIikgY29udGludWU7XHJcbiAgICAgICAgICAgIGlmIChlbWFpbC5jaGFyQXQoaSkgPT0gXCJAXCIpIGNvbnRpbnVlO1xyXG5cclxuICAgICAgICAgICAgY2xlYW5lZHN0cmluZyArPSBlbWFpbC5jaGFyQXQoaSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gY2xlYW5lZHN0cmluZztcclxuICAgIH1cclxuICAgIGdldHNlc3Npb25pZChlbWFpbGlkMTogc3RyaW5nLCBlbWFpbGlkMjogc3RyaW5nKSB7XHJcbiAgICAgICAgZW1haWxpZDEgPSB0aGlzLmNsZWFuZW1haWwoZW1haWxpZDEpO1xyXG4gICAgICAgIGVtYWlsaWQyID0gdGhpcy5jbGVhbmVtYWlsKGVtYWlsaWQyKTtcclxuICAgICAgICB2YXIgc2Vzc2lvbnBhdGggPSBlbWFpbGlkMSA8IGVtYWlsaWQyID8gZW1haWxpZDEgKyBlbWFpbGlkMiA6IGVtYWlsaWQyICsgZW1haWxpZDE7XHJcbiAgICAgICAgcmV0dXJuIHNlc3Npb25wYXRoO1xyXG4gICAgfVxyXG5cclxuICAgIHNhdmVtZXNzYWdlKGZyb206IHN0cmluZywgdG86IHN0cmluZywgbWVzc2FnZTogc3RyaW5nKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coJ3NhdmluZyBtZXNzYWdlIGZyb20gJyArIGZyb20gKyAnIFRvICcgKyB0byk7XHJcbiAgICAgICAgdmFyIHNlc3Npb25pZCA9IHRoaXMuZ2V0c2Vzc2lvbmlkKGZyb20sIHRvKTtcclxuICAgICAgICB2YXIgcGF0aCA9IGAvTWVzc2FnZXMvJHtzZXNzaW9uaWR9YDtcclxuICAgICAgICB2YXIgbXNnc3RhdHVzID0gTWVzc2FnZVN0YXR1cy5QZW5kaW5nO1xyXG4gICAgICAgIHJldHVybiBmaXJlYmFzZS5wdXNoKFxyXG4gICAgICAgICAgICBwYXRoLFxyXG4gICAgICAgICAgICB7IFwic2Vzc2lvbmlkXCI6IHNlc3Npb25pZCwgXCJzZW50YnlcIjogZnJvbSwgXCJyZWNpZXZlZGJ5XCI6IHRvLCBcIm1lc3NhZ2VcIjogbWVzc2FnZSwgXCJtc2dzdGF0dXNcIjogbXNnc3RhdHVzLCBcImRhdGV0aW1lXCI6IDAgLSBEYXRlLm5vdygpLCB1cGRhdGVUczogZmlyZWJhc2UuU2VydmVyVmFsdWUuVElNRVNUQU1QIH1cclxuICAgICAgICApLnRoZW4oXHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChyZXN1bHQ6IGFueSkge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ21lc3NhZ2Ugc2F2ZWQgJyArIEpTT04uc3RyaW5naWZ5KHJlc3VsdCkpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHJlc3VsdCk7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIChlcnJvck1lc3NhZ2U6IGFueSkge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coZXJyb3JNZXNzYWdlKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBnZXRjaGF0TGlzdEJldHdlZW4odXNlcjE6IHN0cmluZywgdXNlcjI6IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBPYnNlcnZhYmxlKChvYnNlcnZlcjogYW55KSA9PiB7XHJcblxyXG4gICAgICAgICAgICB2YXIgc2Vzc2lvbmlkID0gdGhpcy5nZXRzZXNzaW9uaWQodXNlcjEsIHVzZXIyKTtcclxuICAgICAgICAgICAgdmFyIHBhdGggPSBgL01lc3NhZ2VzLyR7c2Vzc2lvbmlkfWA7XHJcbiAgICAgICAgICAgIGxldCBvblZhbHVlRXZlbnQgPSAoc25hcHNob3Q6IGFueSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5uZ1pvbmUucnVuKCgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgcmVzdWx0cyA9IHRoaXMuaGFuZGxlQ2hhdFNuYXBzaG90KHNuYXBzaG90LnZhbHVlKTtcclxuICAgICAgICAgICAgICAgICAgICAvLyAgY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkocmVzdWx0cykpXHJcbiAgICAgICAgICAgICAgICAgICAgb2JzZXJ2ZXIubmV4dChyZXN1bHRzKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBmaXJlYmFzZS5hZGRWYWx1ZUV2ZW50TGlzdGVuZXIob25WYWx1ZUV2ZW50LCBgJHtwYXRofWApO1xyXG4gICAgICAgIH0pLnNoYXJlKCk7XHJcbiAgICB9XHJcbiAgICBoYW5kbGVDaGF0U25hcHNob3QoZGF0YTogYW55KSB7XHJcbiAgICAgICAgLy9lbXB0eSBhcnJheSwgdGhlbiByZWZpbGwgYW5kIGZpbHRlclxyXG4gICAgICAgIHRoaXMuX2NoYXRsaXN0ID0gW107XHJcbiAgICAgICAgaWYgKGRhdGEpIHtcclxuICAgICAgICAgICAgZm9yIChsZXQgaWQgaW4gZGF0YSkge1xyXG4gICAgICAgICAgICAgICAgbGV0IHJlc3VsdCA9ICg8YW55Pk9iamVjdCkuYXNzaWduKHsgaWQ6IGlkIH0sIGRhdGFbaWRdKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuX2NoYXRsaXN0LnB1c2gocmVzdWx0KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLl9jaGF0bGlzdC5zb3J0KGZ1bmN0aW9uIChhLCBiKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoYS5kYXRldGltZSA+IGIuZGF0ZXRpbWUpIHJldHVybiAtMTtcclxuICAgICAgICAgICAgICAgIGlmIChhLmRhdGV0aW1lIDwgYi5kYXRldGltZSkgcmV0dXJuIDE7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gMDtcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgLy8gdGhpcy5wdWJsaXNoVXBkYXRlcygpO1xyXG4gICAgICAgICAgICB0aGlzLl9jaGF0bGlzdG9ic2VydmFibGUubmV4dChbLi4udGhpcy5fY2hhdGxpc3RdKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2NoYXRsaXN0O1xyXG4gICAgfVxyXG4gICAgZmlsdGVyVW5yZWFkKGVtYWlsOiBzdHJpbmcsIGNoYXRsaXN0OiBDaGF0W10pIHtcclxuICAgICAgICByZXR1cm4gY2hhdGxpc3QuZmlsdGVyKGNoYXQgPT4geyByZXR1cm4gKGNoYXQucmVjaWV2ZWRieSA9PSBlbWFpbCAmJiBjaGF0Lm1zZ3N0YXR1cyA9PSA8c3RyaW5nPk1lc3NhZ2VTdGF0dXMuUmVjaWV2ZWRBdFNlcnZlcik7IH0pXHJcblxyXG4gICAgfVxyXG4gICAgbWFya21lc3NhZ2VzYXNyZWFkKGNoYXRsaXN0OiBDaGF0W10pIHtcclxuICAgICAgICBjb25zb2xlLmxvZyhcImNoYXQgbGlzdCBjb3VudDogXCIgKyBjaGF0bGlzdC5sZW5ndGgpO1xyXG5cclxuICAgICAgICB2YXIgY2hhdGlkOiBhbnk7XHJcbiAgICAgICAgdmFyIHJlY2lldmVkQXRTZXJ2ZXIgPSA8c3RyaW5nPk1lc3NhZ2VTdGF0dXMuUmVjaWV2ZWRBdFNlcnZlcjtcclxuICAgICAgICBjb25zb2xlLmxvZyhcInN0YXR1czogXCIgKyByZWNpZXZlZEF0U2VydmVyKTtcclxuICAgICAgICB2YXIgY29udGFpbmVyb2JzZXJ2OiBPYnNlcnZhYmxlPGFueT5bXTtcclxuICAgICAgICB2YXIgdW5yZWFkY2hhdGxpc3QgPSBjaGF0bGlzdC5maWx0ZXIoY2hhdCA9PiB7IHJldHVybiAoY2hhdC5yZWNpZXZlZGJ5ID09IEJhY2tlbmRTZXJ2aWNlLmVtYWlsICYmIGNoYXQubXNnc3RhdHVzID09IHJlY2lldmVkQXRTZXJ2ZXIpOyB9KVxyXG4gICAgICAgIGNvbnNvbGUubG9nKFwiRmlsZXRlcmVkIGNoYXQgbGlzdCBjb3VudDogXCIgKyB1bnJlYWRjaGF0bGlzdC5sZW5ndGgpO1xyXG4gICAgICAgIHZhciB1cGRhdGVvYmogPSB7fTtcclxuICAgICAgICBmb3IgKGNoYXRpZCBpbiB1bnJlYWRjaGF0bGlzdCkge1xyXG4gICAgICAgICAgICB2YXIgY2hhdCA9IDxDaGF0PmNoYXRsaXN0W2NoYXRpZF07XHJcbiAgICAgICAgICAgIC8vIHZhciB1cGRhdGVqc29uID0geyBcIm1zZ3N0YXR1c1wiOjxudW1iZXI+IE1lc3NhZ2VTdGF0dXMuRGVsaXZlcmVkVG9QaG9uZSB9O1xyXG4gICAgICAgICAgICAvLyAgdmFyIHBhdGggPSBgL01lc3NhZ2VzLyR7Y2hhdC5zZXNzaW9uaWR9YDtcclxuICAgICAgICAgICAgdmFyIHBhdGggPSBgL01lc3NhZ2VzLyR7Y2hhdC5zZXNzaW9uaWR9LyR7Y2hhdC5pZH0vbXNnc3RhdHVzYDtcclxuXHJcbiAgICAgICAgICAgIHVwZGF0ZW9ialtwYXRoXSA9IE1lc3NhZ2VTdGF0dXMuRGVsaXZlcmVkVG9QaG9uZTtcclxuICAgICAgICAgICAgLy8gIHZhciB1cGRhdGVvYnNlcnZlID0gT2JzZXJ2YWJsZS5mcm9tUHJvbWlzZShmaXJlYmFzZS5zZXRWYWx1ZShwYXRoLCB1cGRhdGVqc29uKSk7IFxyXG5cclxuICAgICAgICAgICAgLy8gdXBkYXRlb2JzZXJ2ZS5zdWJzY3JpYmUoYSA9PiB7IH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBjb25zb2xlLmxvZygndXBkYXRlIHNhdmVkIHRvIGZpcmJhc2UgJyArIEpTT04uc3RyaW5naWZ5KHVwZGF0ZW9iaikpO1xyXG4gICAgICAgIHJldHVybiBmaXJlYmFzZS51cGRhdGUoJycsIHVwZGF0ZW9iaikudGhlbihyZXMgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gXCJSZWNvcmQgU2F2ZWQgSW4gRmlyZWJhc2VcIjtcclxuICAgICAgICB9KS5jYXRjaChlcnJvck1lc3NhZ2UgPT4ge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhlcnJvck1lc3NhZ2UpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuXHJcbiAgICB9XHJcbiAgICB1cGRhdGVtZXNzYWdlc3RhdHVzKGNoYXQ6IENoYXQpIHtcclxuXHJcbiAgICAgICAgdmFyIHJlY2lldmVkQXRTZXJ2ZXIgPSA8c3RyaW5nPk1lc3NhZ2VTdGF0dXMuUmVjaWV2ZWRBdFNlcnZlcjtcclxuICAgICAgICBjb25zb2xlLmxvZyhcInN0YXR1czogXCIgKyByZWNpZXZlZEF0U2VydmVyKTtcclxuXHJcbiAgICAgICAgdmFyIHVwZGF0ZW9iaiA9IHt9O1xyXG4gICAgICAgIHZhciBwYXRoID0gYC9NZXNzYWdlcy8ke2NoYXQuc2Vzc2lvbmlkfS8ke2NoYXQuaWR9L21zZ3N0YXR1c2A7XHJcbiAgICAgICAgY29uc29sZS5sb2coXCJQYXRoIFRvIERvYyBcIiArIHBhdGgpO1xyXG4gICAgICAgIHVwZGF0ZW9ialtwYXRoXSA9IE1lc3NhZ2VTdGF0dXMuRGVsaXZlcmVkVG9QaG9uZTtcclxuICAgICAgICByZXR1cm4gZmlyZWJhc2UudXBkYXRlKCcnLCB1cGRhdGVvYmopLnRoZW4ocmVzID0+IHtcclxuICAgICAgICAgICAgcmV0dXJuIFwiUmVjb3JkIFNhdmVkIEluIEZpcmViYXNlXCI7XHJcbiAgICAgICAgfSkuY2F0Y2goZXJyb3JNZXNzYWdlID0+IHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coZXJyb3JNZXNzYWdlKTtcclxuICAgICAgICB9KTtcclxuXHJcblxyXG5cclxuXHJcbiAgICB9XHJcblxyXG4gICAgZ2V0dW5yZWFkbWVzc2FnZXMoZGV2aWNlb3duZXI6IHN0cmluZywgcmVtb3RldXNlcjogc3RyaW5nKSB7XHJcbiAgICAgICAgdmFyIHNlc3Npb25pZCA9IHRoaXMuZ2V0c2Vzc2lvbmlkKGRldmljZW93bmVyLCByZW1vdGV1c2VyKTtcclxuICAgICAgICB2YXIgcGF0aCA9IGAvTWVzc2FnZXMvJHtzZXNzaW9uaWR9YDtcclxuXHJcbiAgICAgICAgLy8gdGhpcy5fY2hhdGxpc3RvVXBkYXRlID0gbmV3IFN1YmplY3Q8Q2hhdD4oKTtcclxuXHJcbiAgICAgICAgdmFyIG9uUXVlcnlFdmVudCA9IHJlc3VsdCA9PiB7XHJcblxyXG4gICAgICAgICAgICBpZiAoIXJlc3VsdC5lcnJvciAmJiByZXN1bHQudmFsdWUpIHtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiRXZlbnQgdHlwZTogXCIgKyByZXN1bHQudHlwZSk7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIktleTogXCIgKyByZXN1bHQua2V5KTtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiVmFsdWU6IFwiICsgSlNPTi5zdHJpbmdpZnkocmVzdWx0LnZhbHVlKSk7XHJcbiAgICAgICAgICAgICAgICB2YXIgY2hhdCA9IDxDaGF0PnJlc3VsdC52YWx1ZTtcclxuICAgICAgICAgICAgICAgIGlmIChjaGF0LnJlY2lldmVkYnkgPT0gZGV2aWNlb3duZXIgJiYgY2hhdC5tc2dzdGF0dXMgPT0gPHN0cmluZz5NZXNzYWdlU3RhdHVzLlJlY2lldmVkQXRTZXJ2ZXIpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIk1lc3NhZ2UgRmlyZWQ6IFwiICsgY2hhdC5tZXNzYWdlKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9jaGF0bGlzdG9VcGRhdGUubmV4dChjaGF0KTtcclxuXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgICAgIHJldHVybiBmaXJlYmFzZS5xdWVyeShcclxuICAgICAgICAgICAgb25RdWVyeUV2ZW50LFxyXG4gICAgICAgICAgICBwYXRoLFxyXG4gICAgICAgICAgICB7XHJcblxyXG4gICAgICAgICAgICAgICAgc2luZ2xlRXZlbnQ6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgLy8gb3JkZXIgYnkgY29tcGFueS5jb3VudHJ5XHJcbiAgICAgICAgICAgICAgICBvcmRlckJ5OiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogZmlyZWJhc2UuUXVlcnlPcmRlckJ5VHlwZS5LRVkvLyxcclxuICAgICAgICAgICAgICAgICAgICAvLyB2YWx1ZTogJ21zZ3N0YXR1cycgLy8gbWFuZGF0b3J5IHdoZW4gdHlwZSBpcyAnY2hpbGQnXHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgLy8gYnV0IG9ubHkgY29tcGFuaWVzICdzaW5jZScgYSBjZXJ0YWluIHllYXIgKFRlbGVyaWsncyB2YWx1ZSBpcyAyMDAwLCB3aGljaCBpcyBpbWFnaW5hcnkgYnR3KVxyXG4gICAgICAgICAgICAgICAgLy8gdXNlIGVpdGhlciBhICdyYW5nZSdcclxuICAgICAgICAgICAgICAgIC8vcmFuZ2U6IHtcclxuICAgICAgICAgICAgICAgIC8vICAgIHR5cGU6IGZpcmViYXNlLlF1ZXJ5UmFuZ2VUeXBlLkVRVUFMX1RPLFxyXG4gICAgICAgICAgICAgICAgLy8gICAgdmFsdWU6IE1lc3NhZ2VTdGF0dXMuUmVjaWV2ZWRBdFNlcnZlclxyXG4gICAgICAgICAgICAgICAgLy99XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICApLnRoZW4ocmVzdWx0ID0+IHtcclxuXHJcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIGdldGNoYXRMaXN0QmV0d2VlbjEoZGV2aWNlb3duZXI6IHN0cmluZywgcmVtb3RldXNlcjogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgICAgICByZXR1cm4gbmV3IE9ic2VydmFibGUoKG9ic2VydmVyOiBhbnkpID0+IHtcclxuXHJcbiAgICAgICAgICAgIHZhciBzZXNzaW9uaWQgPSB0aGlzLmdldHNlc3Npb25pZChkZXZpY2Vvd25lciwgcmVtb3RldXNlcik7XHJcbiAgICAgICAgICAgIHZhciBwYXRoID0gYC9NZXNzYWdlcy8ke3Nlc3Npb25pZH1gO1xyXG4gICAgICAgICAgICB2YXIgb25RdWVyeUV2ZW50ID0gcmVzdWx0ID0+IHtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAoIXJlc3VsdC5lcnJvciAmJiByZXN1bHQudmFsdWUpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIkV2ZW50IHR5cGU6IFwiICsgcmVzdWx0LnR5cGUpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiS2V5OiBcIiArIHJlc3VsdC5rZXkpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiVmFsdWU6IFwiICsgSlNPTi5zdHJpbmdpZnkocmVzdWx0LnZhbHVlKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGNoYXQgPSA8Q2hhdD5yZXN1bHQudmFsdWU7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNoYXQucmVjaWV2ZWRieSA9PSBkZXZpY2Vvd25lciAmJiBjaGF0Lm1zZ3N0YXR1cyA9PSA8c3RyaW5nPk1lc3NhZ2VTdGF0dXMuUmVjaWV2ZWRBdFNlcnZlcikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIk1lc3NhZ2UgRmlyZWQ6IFwiICsgY2hhdC5tZXNzYWdlKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubmdab25lLnJ1bigoKSA9PiB7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgb2JzZXJ2ZXIubmV4dChjaGF0KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBmaXJlYmFzZS5xdWVyeShcclxuICAgICAgICAgICAgICAgIG9uUXVlcnlFdmVudCxcclxuICAgICAgICAgICAgICAgIHBhdGgsXHJcbiAgICAgICAgICAgICAgICB7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHNpbmdsZUV2ZW50OiBmYWxzZSxcclxuICAgICAgICAgICAgICAgICAgICAvLyBvcmRlciBieSBjb21wYW55LmNvdW50cnlcclxuICAgICAgICAgICAgICAgICAgICBvcmRlckJ5OiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IGZpcmViYXNlLlF1ZXJ5T3JkZXJCeVR5cGUuS0VZLy8sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHZhbHVlOiAnbXNnc3RhdHVzJyAvLyBtYW5kYXRvcnkgd2hlbiB0eXBlIGlzICdjaGlsZCdcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG5cclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgKS50aGVuKHJlc3VsdCA9PiB7XHJcblxyXG5cclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIH0pLnNoYXJlKCk7XHJcbiAgICB9XHJcblxyXG59Il19