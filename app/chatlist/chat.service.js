"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var firebase = require("nativescript-plugin-firebase");
var Observable_1 = require("rxjs/Observable");
var BehaviorSubject_1 = require("rxjs/BehaviorSubject");
var Subject_1 = require("rxjs/Subject");
require("rxjs/add/operator/share");
var chat_model_1 = require("./chat.model");
var services_1 = require("../services");
var ChatService = (function () {
    function ChatService(ngZone) {
        this.ngZone = ngZone;
        this._chatlist = [];
        this._chatlistobservable = new BehaviorSubject_1.BehaviorSubject([]);
        this._chatlistoUpdate = new Subject_1.Subject();
    }
    ChatService.prototype.cleanemail = function (email) {
        var charactercount = email.length;
        var cleanedstring = "";
        var i;
        for (i = 0; i < charactercount; i++) {
            if (email.charAt(i) == ".")
                continue;
            cleanedstring += email.charAt(i);
        }
        return cleanedstring;
    };
    ChatService.prototype.getsessionid = function (emailid1, emailid2) {
        emailid1 = this.cleanemail(emailid1);
        emailid2 = this.cleanemail(emailid2);
        var sessionpath = emailid1 < emailid2 ? emailid1 + emailid2 : emailid2 + emailid1;
        return sessionpath;
    };
    ChatService.prototype.savemessage = function (from, to, message) {
        console.log('saving message from ' + from + ' To ' + to);
        var sessionid = this.getsessionid(from, to);
        var path = "/Messages/" + sessionid;
        var msgstatus = chat_model_1.MessageStatus.Pending;
        return firebase.push(path, { "sessionid": sessionid, "sentby": from, "recievedby": to, "message": message, "msgstatus": msgstatus, "datetime": 0 - Date.now(), updateTs: firebase.ServerValue.TIMESTAMP }).then(function (result) {
            console.log('message saved ' + JSON.stringify(result));
            return JSON.stringify(result);
        }, function (errorMessage) {
            console.log(errorMessage);
        });
    };
    ChatService.prototype.getchatListBetween = function (user1, user2) {
        var _this = this;
        return new Observable_1.Observable(function (observer) {
            var sessionid = _this.getsessionid(user1, user2);
            var path = "/Messages/" + sessionid;
            var onValueEvent = function (snapshot) {
                _this.ngZone.run(function () {
                    var results = _this.handleChatSnapshot(snapshot.value);
                    observer.next(results);
                });
            };
            firebase.addValueEventListener(onValueEvent, "" + path);
        }).share();
    };
    ChatService.prototype.handleChatSnapshot = function (data) {
        this._chatlist = [];
        if (data) {
            for (var id in data) {
                var result = Object.assign({ id: id }, data[id]);
                this._chatlist.push(result);
            }
            this._chatlist.sort(function (a, b) {
                if (a.datetime > b.datetime)
                    return -1;
                if (a.datetime < b.datetime)
                    return 1;
                return 0;
            });
            this._chatlistobservable.next(this._chatlist.slice());
        }
        return this._chatlist;
    };
    ChatService.prototype.filterUnread = function (email, chatlist) {
        return chatlist.filter(function (chat) { return (chat.recievedby == email && chat.msgstatus == chat_model_1.MessageStatus.RecievedAtServer); });
    };
    ChatService.prototype.markmessagesasread = function (chatlist) {
        console.log("chat list count: " + chatlist.length);
        var chatid;
        var recievedAtServer = chat_model_1.MessageStatus.RecievedAtServer;
        console.log("status: " + recievedAtServer);
        var containerobserv;
        var unreadchatlist = chatlist.filter(function (chat) { return (chat.recievedby == services_1.BackendService.email && chat.msgstatus == recievedAtServer); });
        console.log("Filetered chat list count: " + unreadchatlist.length);
        var updateobj = {};
        for (chatid in unreadchatlist) {
            var chat = chatlist[chatid];
            var path = "/Messages/" + chat.sessionid + "/" + chat.id + "/msgstatus";
            updateobj[path] = chat_model_1.MessageStatus.DeliveredToPhone;
        }
        return firebase.update('', updateobj).then(function (res) {
            return "Record Saved In Firebase";
        }).catch(function (errorMessage) {
            console.log(errorMessage);
        });
    };
    ChatService.prototype.updatemessagestatus = function (chat) {
        var recievedAtServer = chat_model_1.MessageStatus.RecievedAtServer;
        console.log("status: " + recievedAtServer);
        var updateobj = {};
        var path = "/Messages/" + chat.sessionid + "/" + chat.id + "/msgstatus";
        console.log("Path To Doc " + path);
        updateobj[path] = chat_model_1.MessageStatus.DeliveredToPhone;
        return firebase.update('', updateobj).then(function (res) {
            return "Record Saved In Firebase";
        }).catch(function (errorMessage) {
            console.log(errorMessage);
        });
    };
    ChatService.prototype.getunreadmessages = function (deviceowner, remoteuser) {
        var _this = this;
        var sessionid = this.getsessionid(deviceowner, remoteuser);
        var path = "/Messages/" + sessionid;
        var onQueryEvent = function (result) {
            if (!result.error && result.value) {
                console.log("Event type: " + result.type);
                console.log("Key: " + result.key);
                console.log("Value: " + JSON.stringify(result.value));
                var chat = result.value;
                if (chat.recievedby == deviceowner && chat.msgstatus == chat_model_1.MessageStatus.RecievedAtServer) {
                    console.log("Message Fired: " + chat.message);
                    _this._chatlistoUpdate.next(chat);
                }
            }
        };
        return firebase.query(onQueryEvent, path, {
            singleEvent: false,
            orderBy: {
                type: firebase.QueryOrderByType.KEY
            },
        }).then(function (result) {
            return result;
        });
    };
    ChatService.prototype.getchatListBetween1 = function (deviceowner, remoteuser) {
        var _this = this;
        return new Observable_1.Observable(function (observer) {
            var sessionid = _this.getsessionid(deviceowner, remoteuser);
            var path = "/Messages/" + sessionid;
            var onQueryEvent = function (result) {
                if (!result.error && result.value) {
                    console.log("Event type: " + result.type);
                    console.log("Key: " + result.key);
                    console.log("Value: " + JSON.stringify(result.value));
                    var chat = result.value;
                    if (chat.recievedby == deviceowner && chat.msgstatus == chat_model_1.MessageStatus.RecievedAtServer) {
                        console.log("Message Fired: " + chat.message);
                        _this.ngZone.run(function () {
                            observer.next(chat);
                        });
                    }
                }
            };
            firebase.query(onQueryEvent, path, {
                singleEvent: false,
                orderBy: {
                    type: firebase.QueryOrderByType.KEY
                },
            }).then(function (result) {
            });
        }).share();
    };
    return ChatService;
}());
ChatService = __decorate([
    core_1.Injectable(),
    __metadata("design:paramtypes", [core_1.NgZone])
], ChatService);
exports.ChatService = ChatService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hhdC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY2hhdC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUEsc0NBQTJEO0FBQzNELHVEQUEwRDtBQUMxRCw4Q0FBNkM7QUFDN0Msd0RBQXVEO0FBQ3ZELHdDQUF1QztBQUV2QyxtQ0FBaUM7QUFDakMsMkNBQTZDO0FBRTdDLHdDQUE2QztBQUk3QyxJQUFhLFdBQVc7SUFDcEIscUJBQ1ksTUFBYztRQUFkLFdBQU0sR0FBTixNQUFNLENBQVE7UUFHbEIsY0FBUyxHQUFnQixFQUFFLENBQUM7UUFDcEMsd0JBQW1CLEdBQWlDLElBQUksaUNBQWUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUM1RSxxQkFBZ0IsR0FBa0IsSUFBSSxpQkFBTyxFQUFRLENBQUM7SUFKbEQsQ0FBQztJQUtMLGdDQUFVLEdBQVYsVUFBVyxLQUFhO1FBRXBCLElBQUksY0FBYyxHQUFXLEtBQUssQ0FBQyxNQUFNLENBQUM7UUFDMUMsSUFBSSxhQUFhLEdBQVcsRUFBRSxDQUFDO1FBQUMsSUFBSSxDQUFTLENBQUM7UUFDOUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsY0FBYyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7WUFDbEMsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsSUFBSSxHQUFHLENBQUM7Z0JBQUMsUUFBUSxDQUFDO1lBQ3JDLGFBQWEsSUFBSSxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3JDLENBQUM7UUFFRCxNQUFNLENBQUMsYUFBYSxDQUFDO0lBQ3pCLENBQUM7SUFDRCxrQ0FBWSxHQUFaLFVBQWEsUUFBZ0IsRUFBRSxRQUFnQjtRQUMzQyxRQUFRLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNyQyxRQUFRLEdBQUcsSUFBSSxDQUFD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SUFBSSxHQUFTLE1BQU0sQ0FBQyxLQUFLLENBQUM7b0JBQzlCLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLElBQUksV0FBVyxJQUFJLElBQUksQ0FBQyxTQUFTLElBQVksMEJBQWEsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUM7d0JBQzdGLE9BQU8sQ0FBQyxHQUFHLENBQUMsaUJBQWlCLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO3dCQUU5QyxLQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQzs0QkFFWixRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO3dCQUN4QixDQUFDLENBQUMsQ0FBQztvQkFDUCxDQUFDO2dCQUNMLENBQUM7WUFDTCxDQUFDLENBQUM7WUFDRixRQUFRLENBQUMsS0FBSyxDQUNWLFlBQVksRUFDWixJQUFJLEVBQ0o7Z0JBRUksV0FBVyxFQUFFLEtBQUs7Z0JBRWxCLE9BQU8sRUFBRTtvQkFDTCxJQUFJLEVBQUUsUUFBUSxDQUFDLGdCQUFnQixDQUFDLEdBQUc7aUJBRXRDO2FBRUosQ0FDSixDQUFDLElBQUksQ0FBQyxVQUFBLE1BQU07WUFHYixDQUFDLENBQUMsQ0FBQztRQUVQLENBQUMsQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQ2YsQ0FBQztJQUVMLGtCQUFDO0FBQUQsQ0FBQyxBQTVORCxJQTROQztBQTVOWSxXQUFXO0lBRHZCLGlCQUFVLEVBQUU7cUNBR1csYUFBTTtHQUZqQixXQUFXLENBNE52QjtBQTVOWSxrQ0FBVyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIEluamVjdCwgTmdab25lIH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcbmltcG9ydCBmaXJlYmFzZSA9IHJlcXVpcmUoXCJuYXRpdmVzY3JpcHQtcGx1Z2luLWZpcmViYXNlXCIpO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMvT2JzZXJ2YWJsZSc7XG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QgfSBmcm9tICdyeGpzL0JlaGF2aW9yU3ViamVjdCc7XG5pbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSAncnhqcy9TdWJqZWN0JztcblxuaW1wb3J0ICdyeGpzL2FkZC9vcGVyYXRvci9zaGFyZSc7XG5pbXBvcnQgeyBNZXNzYWdlU3RhdHVzIH0gZnJvbSBcIi4vY2hhdC5tb2RlbFwiO1xuaW1wb3J0IHsgQ2hhdCB9IGZyb20gXCIuL2NoYXQubW9kZWxcIjtcbmltcG9ydCB7IEJhY2tlbmRTZXJ2aWNlIH0gZnJvbSBcIi4uL3NlcnZpY2VzXCI7XG5cblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIENoYXRTZXJ2aWNlIHtcbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJpdmF0ZSBuZ1pvbmU6IE5nWm9uZVxuICAgICkgeyB9XG5cbiAgICBwcml2YXRlIF9jaGF0bGlzdDogQXJyYXk8Q2hhdD4gPSBbXTtcbiAgICBfY2hhdGxpc3RvYnNlcnZhYmxlOiBCZWhhdmlvclN1YmplY3Q8QXJyYXk8Q2hhdD4+ID0gbmV3IEJlaGF2aW9yU3ViamVjdChbXSk7XG4gICAgX2NoYXRsaXN0b1VwZGF0ZTogU3ViamVjdDxDaGF0PiA9IG5ldyBTdWJqZWN0PENoYXQ+KCk7XG4gICAgY2xlYW5lbWFpbChlbWFpbDogc3RyaW5nKSB7XG5cbiAgICAgICAgdmFyIGNoYXJhY3RlcmNvdW50OiBudW1iZXIgPSBlbWFpbC5sZW5ndGg7XHJcbiAgICAgICAgdmFyIGNsZWFuZWRzdHJpbmc6IHN0cmluZyA9IFwiXCI7IHZhciBpOiBudW1iZXI7XHJcbiAgICAgICAgZm9yIChpID0gMDsgaSA8IGNoYXJhY3RlcmNvdW50OyBpKyspIHtcclxuICAgICAgICAgICAgaWYgKGVtYWlsLmNoYXJBdChpKSA9PSBcIi5cIikgY29udGludWU7XHJcbiAgICAgICAgICAgIGNsZWFuZWRzdHJpbmcgKz0gZW1haWwuY2hhckF0KGkpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIGNsZWFuZWRzdHJpbmc7XHJcbiAgICB9XG4gICAgZ2V0c2Vzc2lvbmlkKGVtYWlsaWQxOiBzdHJpbmcsIGVtYWlsaWQyOiBzdHJpbmcpIHtcbiAgICAgICAgZW1haWxpZDEgPSB0aGlzLmNsZWFuZW1haWwoZW1haWxpZDEpO1xuICAgICAgICBlbWFpbGlkMiA9IHRoaXMuY2xlYW5lbWFpbChlbWFpbGlkMik7XG4gICAgICAgIHZhciBzZXNzaW9ucGF0aCA9IGVtYWlsaWQxIDwgZW1haWxpZDIgPyBlbWFpbGlkMSArIGVtYWlsaWQyIDogZW1haWxpZDIgKyBlbWFpbGlkMTtcbiAgICAgICAgcmV0dXJuIHNlc3Npb25wYXRoO1xuICAgIH1cclxuXHJcbiAgICBzYXZlbWVzc2FnZShmcm9tOiBzdHJpbmcsIHRvOiBzdHJpbmcsIG1lc3NhZ2U6IHN0cmluZykge1xuICAgICAgICBjb25zb2xlLmxvZygnc2F2aW5nIG1lc3NhZ2UgZnJvbSAnICsgZnJvbSArICcgVG8gJyArIHRvKTtcbiAgICAgICAgdmFyIHNlc3Npb25pZCA9IHRoaXMuZ2V0c2Vzc2lvbmlkKGZyb20sIHRvKTtcbiAgICAgICAgdmFyIHBhdGggPSBgL01lc3NhZ2VzLyR7c2Vzc2lvbmlkfWA7XG4gICAgICAgIHZhciBtc2dzdGF0dXMgPSBNZXNzYWdlU3RhdHVzLlBlbmRpbmc7XG4gICAgICAgIHJldHVybiBmaXJlYmFzZS5wdXNoKFxuICAgICAgICAgICAgcGF0aCxcbiAgICAgICAgICAgIHsgXCJzZXNzaW9uaWRcIjogc2Vzc2lvbmlkLCBcInNlbnRieVwiOiBmcm9tLCBcInJlY2lldmVkYnlcIjogdG8sIFwibWVzc2FnZVwiOiBtZXNzYWdlLCBcIm1zZ3N0YXR1c1wiOiBtc2dzdGF0dXMsIFwiZGF0ZXRpbWVcIjogMCAtIERhdGUubm93KCksIHVwZGF0ZVRzOiBmaXJlYmFzZS5TZXJ2ZXJWYWx1ZS5USU1FU1RBTVAgfVxuICAgICAgICApLnRoZW4oXG4gICAgICAgICAgICBmdW5jdGlvbiAocmVzdWx0OiBhbnkpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnbWVzc2FnZSBzYXZlZCAnICsgSlNPTi5zdHJpbmdpZnkocmVzdWx0KSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHJlc3VsdCk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZnVuY3Rpb24gKGVycm9yTWVzc2FnZTogYW55KSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coZXJyb3JNZXNzYWdlKTtcbiAgICAgICAgICAgIH0pO1xuICAgIH1cbiAgICBnZXRjaGF0TGlzdEJldHdlZW4odXNlcjE6IHN0cmluZywgdXNlcjI6IHN0cmluZyk6IE9ic2VydmFibGU8YW55PiB7XG4gICAgICAgIHJldHVybiBuZXcgT2JzZXJ2YWJsZSgob2JzZXJ2ZXI6IGFueSkgPT4ge1xuXG4gICAgICAgICAgICB2YXIgc2Vzc2lvbmlkID0gdGhpcy5nZXRzZXNzaW9uaWQodXNlcjEsIHVzZXIyKTtcbiAgICAgICAgICAgIHZhciBwYXRoID0gYC9NZXNzYWdlcy8ke3Nlc3Npb25pZH1gO1xuICAgICAgICAgICAgbGV0IG9uVmFsdWVFdmVudCA9IChzbmFwc2hvdDogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5uZ1pvbmUucnVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHJlc3VsdHMgPSB0aGlzLmhhbmRsZUNoYXRTbmFwc2hvdChzbmFwc2hvdC52YWx1ZSk7XG4gICAgICAgICAgICAgICAgICAgIC8vICBjb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeShyZXN1bHRzKSlcbiAgICAgICAgICAgICAgICAgICAgb2JzZXJ2ZXIubmV4dChyZXN1bHRzKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBmaXJlYmFzZS5hZGRWYWx1ZUV2ZW50TGlzdGVuZXIob25WYWx1ZUV2ZW50LCBgJHtwYXRofWApO1xuICAgICAgICB9KS5zaGFyZSgpO1xuICAgIH1cbiAgICBoYW5kbGVDaGF0U25hcHNob3QoZGF0YTogYW55KSB7XG4gICAgICAgIC8vZW1wdHkgYXJyYXksIHRoZW4gcmVmaWxsIGFuZCBmaWx0ZXJcbiAgICAgICAgdGhpcy5fY2hhdGxpc3QgPSBbXTtcbiAgICAgICAgaWYgKGRhdGEpIHtcbiAgICAgICAgICAgIGZvciAobGV0IGlkIGluIGRhdGEpIHtcbiAgICAgICAgICAgICAgICBsZXQgcmVzdWx0ID0gKDxhbnk+T2JqZWN0KS5hc3NpZ24oeyBpZDogaWQgfSwgZGF0YVtpZF0pO1xuICAgICAgICAgICAgICAgIHRoaXMuX2NoYXRsaXN0LnB1c2gocmVzdWx0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuX2NoYXRsaXN0LnNvcnQoZnVuY3Rpb24gKGEsIGIpIHtcbiAgICAgICAgICAgICAgICBpZiAoYS5kYXRldGltZSA+IGIuZGF0ZXRpbWUpIHJldHVybiAtMTtcbiAgICAgICAgICAgICAgICBpZiAoYS5kYXRldGltZSA8IGIuZGF0ZXRpbWUpIHJldHVybiAxO1xuICAgICAgICAgICAgICAgIHJldHVybiAwO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC8vIHRoaXMucHVibGlzaFVwZGF0ZXMoKTtcbiAgICAgICAgICAgIHRoaXMuX2NoYXRsaXN0b2JzZXJ2YWJsZS5uZXh0KFsuLi50aGlzLl9jaGF0bGlzdF0pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLl9jaGF0bGlzdDtcbiAgICB9XG4gICAgZmlsdGVyVW5yZWFkKGVtYWlsOiBzdHJpbmcsY2hhdGxpc3Q6IENoYXRbXSlcbiAgICB7XG4gICAgICAgIHJldHVybiBjaGF0bGlzdC5maWx0ZXIoY2hhdCA9PiB7IHJldHVybiAoY2hhdC5yZWNpZXZlZGJ5ID09IGVtYWlsICYmIGNoYXQubXNnc3RhdHVzID09IDxzdHJpbmc+TWVzc2FnZVN0YXR1cy5SZWNpZXZlZEF0U2VydmVyKTsgfSlcblxyXG4gICAgfVxuICAgIG1hcmttZXNzYWdlc2FzcmVhZChjaGF0bGlzdDogQ2hhdFtdKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiY2hhdCBsaXN0IGNvdW50OiBcIiArIGNoYXRsaXN0Lmxlbmd0aCk7XG5cbiAgICAgICAgdmFyIGNoYXRpZDogYW55O1xuICAgICAgICB2YXIgcmVjaWV2ZWRBdFNlcnZlciA9IDxzdHJpbmc+TWVzc2FnZVN0YXR1cy5SZWNpZXZlZEF0U2VydmVyO1xuICAgICAgICBjb25zb2xlLmxvZyhcInN0YXR1czogXCIgKyByZWNpZXZlZEF0U2VydmVyKTtcbiAgICAgICAgdmFyIGNvbnRhaW5lcm9ic2VydjogT2JzZXJ2YWJsZTxhbnk+W107XG4gICAgICAgIHZhciB1bnJlYWRjaGF0bGlzdCA9IGNoYXRsaXN0LmZpbHRlcihjaGF0ID0+IHsgcmV0dXJuIChjaGF0LnJlY2lldmVkYnkgPT0gQmFja2VuZFNlcnZpY2UuZW1haWwgJiYgY2hhdC5tc2dzdGF0dXMgPT0gcmVjaWV2ZWRBdFNlcnZlcik7IH0pXG4gICAgICAgIGNvbnNvbGUubG9nKFwiRmlsZXRlcmVkIGNoYXQgbGlzdCBjb3VudDogXCIgKyB1bnJlYWRjaGF0bGlzdC5sZW5ndGgpO1xyXG4gICAgICAgIHZhciB1cGRhdGVvYmogPSB7fTtcclxuICAgICAgICBmb3IgKGNoYXRpZCBpbiB1bnJlYWRjaGF0bGlzdCkge1xyXG4gICAgICAgICAgICB2YXIgY2hhdCA9IDxDaGF0PmNoYXRsaXN0W2NoYXRpZF07XHJcbiAgICAgICAgICAgIC8vIHZhciB1cGRhdGVqc29uID0geyBcIm1zZ3N0YXR1c1wiOjxudW1iZXI+IE1lc3NhZ2VTdGF0dXMuRGVsaXZlcmVkVG9QaG9uZSB9O1xyXG4gICAgICAgICAgICAvLyAgdmFyIHBhdGggPSBgL01lc3NhZ2VzLyR7Y2hhdC5zZXNzaW9uaWR9YDtcclxuICAgICAgICAgICAgdmFyIHBhdGggPSBgL01lc3NhZ2VzLyR7Y2hhdC5zZXNzaW9uaWR9LyR7Y2hhdC5pZH0vbXNnc3RhdHVzYDtcclxuXHJcbiAgICAgICAgICAgIHVwZGF0ZW9ialtwYXRoXSA9IE1lc3NhZ2VTdGF0dXMuRGVsaXZlcmVkVG9QaG9uZTtcclxuICAgICAgICAgICAgLy8gIHZhciB1cGRhdGVvYnNlcnZlID0gT2JzZXJ2YWJsZS5mcm9tUHJvbWlzZShmaXJlYmFzZS5zZXRWYWx1ZShwYXRoLCB1cGRhdGVqc29uKSk7IFxyXG5cclxuICAgICAgICAgICAgLy8gdXBkYXRlb2JzZXJ2ZS5zdWJzY3JpYmUoYSA9PiB7IH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICAvLyBjb25zb2xlLmxvZygndXBkYXRlIHNhdmVkIHRvIGZpcmJhc2UgJyArIEpTT04uc3RyaW5naWZ5KHVwZGF0ZW9iaikpO1xyXG4gICAgICAgIHJldHVybiBmaXJlYmFzZS51cGRhdGUoJycsIHVwZGF0ZW9iaikudGhlbihyZXMgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIFwiUmVjb3JkIFNhdmVkIEluIEZpcmViYXNlXCI7XHJcbiAgICAgICAgfSkuY2F0Y2goZXJyb3JNZXNzYWdlID0+IHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coZXJyb3JNZXNzYWdlKTtcclxuICAgICAgICB9KTtcclxuXHJcblxyXG4gICAgfVxuICAgIHVwZGF0ZW1lc3NhZ2VzdGF0dXMoY2hhdDogQ2hhdCkge1xuICAgICAgICAgICAgIFxuICAgICAgICB2YXIgcmVjaWV2ZWRBdFNlcnZlciA9IDxzdHJpbmc+TWVzc2FnZVN0YXR1cy5SZWNpZXZlZEF0U2VydmVyO1xuICAgICAgICBjb25zb2xlLmxvZyhcInN0YXR1czogXCIgKyByZWNpZXZlZEF0U2VydmVyKTtcbiAgICAgICBcclxuICAgICAgICB2YXIgdXBkYXRlb2JqID0ge307XHJcbiAgICAgICAgdmFyIHBhdGggPSBgL01lc3NhZ2VzLyR7Y2hhdC5zZXNzaW9uaWR9LyR7Y2hhdC5pZH0vbXNnc3RhdHVzYDtcclxuICAgICAgICBjb25zb2xlLmxvZyhcIlBhdGggVG8gRG9jIFwiICsgcGF0aCk7XHJcbiAgICAgICAgdXBkYXRlb2JqW3BhdGhdID0gTWVzc2FnZVN0YXR1cy5EZWxpdmVyZWRUb1Bob25lO1xyXG4gICAgICAgIHJldHVybiBmaXJlYmFzZS51cGRhdGUoJycsIHVwZGF0ZW9iaikudGhlbihyZXMgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIFwiUmVjb3JkIFNhdmVkIEluIEZpcmViYXNlXCI7XHJcbiAgICAgICAgfSkuY2F0Y2goZXJyb3JNZXNzYWdlID0+IHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coZXJyb3JNZXNzYWdlKTtcclxuICAgICAgICB9KTtcclxuICAgICAgIFxyXG4gICAgICBcclxuXHJcblxyXG4gICAgfVxuXG4gICAgZ2V0dW5yZWFkbWVzc2FnZXMoZGV2aWNlb3duZXI6IHN0cmluZywgcmVtb3RldXNlcjogc3RyaW5nKSB7XG4gICAgICAgIHZhciBzZXNzaW9uaWQgPSB0aGlzLmdldHNlc3Npb25pZChkZXZpY2Vvd25lciwgcmVtb3RldXNlcik7XHJcbiAgICAgICAgdmFyIHBhdGggPSBgL01lc3NhZ2VzLyR7c2Vzc2lvbmlkfWA7XHJcbiAgICAgIFxyXG4gICAgIC8vIHRoaXMuX2NoYXRsaXN0b1VwZGF0ZSA9IG5ldyBTdWJqZWN0PENoYXQ+KCk7XHJcbiAgICBcclxuICAgICAgICB2YXIgb25RdWVyeUV2ZW50ID0gcmVzdWx0ID0+IHtcclxuXHJcbiAgICAgICAgICAgIGlmICghcmVzdWx0LmVycm9yICYmIHJlc3VsdC52YWx1ZSkge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJFdmVudCB0eXBlOiBcIiArIHJlc3VsdC50eXBlKTtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiS2V5OiBcIiArIHJlc3VsdC5rZXkpO1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJWYWx1ZTogXCIgKyBKU09OLnN0cmluZ2lmeShyZXN1bHQudmFsdWUpKTtcclxuICAgICAgICAgICAgICAgIHZhciBjaGF0ID0gPENoYXQ+cmVzdWx0LnZhbHVlO1xyXG4gICAgICAgICAgICAgICAgaWYgKGNoYXQucmVjaWV2ZWRieSA9PSBkZXZpY2Vvd25lciAmJiBjaGF0Lm1zZ3N0YXR1cyA9PSA8c3RyaW5nPk1lc3NhZ2VTdGF0dXMuUmVjaWV2ZWRBdFNlcnZlcilcclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIk1lc3NhZ2UgRmlyZWQ6IFwiICsgY2hhdC5tZXNzYWdlKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9jaGF0bGlzdG9VcGRhdGUubmV4dChjaGF0KTtcclxuICAgICAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH07XHJcbiAgICAgICByZXR1cm4gZmlyZWJhc2UucXVlcnkoXHJcbiAgICAgICAgICAgIG9uUXVlcnlFdmVudCxcclxuICAgICAgICAgICAgcGF0aCxcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICBzaW5nbGVFdmVudDogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICAvLyBvcmRlciBieSBjb21wYW55LmNvdW50cnlcclxuICAgICAgICAgICAgICAgIG9yZGVyQnk6IHtcclxuICAgICAgICAgICAgICAgICAgICB0eXBlOiBmaXJlYmFzZS5RdWVyeU9yZGVyQnlUeXBlLktFWS8vLFxyXG4gICAgICAgICAgICAgICAgICAgLy8gdmFsdWU6ICdtc2dzdGF0dXMnIC8vIG1hbmRhdG9yeSB3aGVuIHR5cGUgaXMgJ2NoaWxkJ1xyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIC8vIGJ1dCBvbmx5IGNvbXBhbmllcyAnc2luY2UnIGEgY2VydGFpbiB5ZWFyIChUZWxlcmlrJ3MgdmFsdWUgaXMgMjAwMCwgd2hpY2ggaXMgaW1hZ2luYXJ5IGJ0dylcclxuICAgICAgICAgICAgICAgIC8vIHVzZSBlaXRoZXIgYSAncmFuZ2UnXHJcbiAgICAgICAgICAgICAgICAvL3JhbmdlOiB7XHJcbiAgICAgICAgICAgICAgICAvLyAgICB0eXBlOiBmaXJlYmFzZS5RdWVyeVJhbmdlVHlwZS5FUVVBTF9UTyxcclxuICAgICAgICAgICAgICAgIC8vICAgIHZhbHVlOiBNZXNzYWdlU3RhdHVzLlJlY2lldmVkQXRTZXJ2ZXJcclxuICAgICAgICAgICAgICAgIC8vfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgKS50aGVuKHJlc3VsdCA9PiB7XHJcbiAgICAgICAgICAgXHJcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XHJcbiAgICAgICAgICAgfSk7XHJcblxyXG4gICAgfVxuICAgIFxuICAgIGdldGNoYXRMaXN0QmV0d2VlbjEoZGV2aWNlb3duZXI6IHN0cmluZywgcmVtb3RldXNlcjogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBPYnNlcnZhYmxlKChvYnNlcnZlcjogYW55KSA9PiB7XG5cbiAgICAgICAgICAgIHZhciBzZXNzaW9uaWQgPSB0aGlzLmdldHNlc3Npb25pZChkZXZpY2Vvd25lciwgcmVtb3RldXNlcik7XG4gICAgICAgICAgICB2YXIgcGF0aCA9IGAvTWVzc2FnZXMvJHtzZXNzaW9uaWR9YDtcbiAgICAgICAgICAgIHZhciBvblF1ZXJ5RXZlbnQgPSByZXN1bHQgPT4ge1xyXG5cclxuICAgICAgICAgICAgICAgIGlmICghcmVzdWx0LmVycm9yICYmIHJlc3VsdC52YWx1ZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiRXZlbnQgdHlwZTogXCIgKyByZXN1bHQudHlwZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJLZXk6IFwiICsgcmVzdWx0LmtleSk7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJWYWx1ZTogXCIgKyBKU09OLnN0cmluZ2lmeShyZXN1bHQudmFsdWUpKTtcclxuICAgICAgICAgICAgICAgICAgICB2YXIgY2hhdCA9IDxDaGF0PnJlc3VsdC52YWx1ZTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoY2hhdC5yZWNpZXZlZGJ5ID09IGRldmljZW93bmVyICYmIGNoYXQubXNnc3RhdHVzID09IDxzdHJpbmc+TWVzc2FnZVN0YXR1cy5SZWNpZXZlZEF0U2VydmVyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiTWVzc2FnZSBGaXJlZDogXCIgKyBjaGF0Lm1lc3NhZ2UpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMubmdab25lLnJ1bigoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYnNlcnZlci5uZXh0KGNoYXQpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBmaXJlYmFzZS5xdWVyeShcclxuICAgICAgICAgICAgICAgIG9uUXVlcnlFdmVudCxcclxuICAgICAgICAgICAgICAgIHBhdGgsXHJcbiAgICAgICAgICAgICAgICB7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIHNpbmdsZUV2ZW50OiBmYWxzZSxcclxuICAgICAgICAgICAgICAgICAgICAvLyBvcmRlciBieSBjb21wYW55LmNvdW50cnlcclxuICAgICAgICAgICAgICAgICAgICBvcmRlckJ5OiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IGZpcmViYXNlLlF1ZXJ5T3JkZXJCeVR5cGUuS0VZLy8sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHZhbHVlOiAnbXNnc3RhdHVzJyAvLyBtYW5kYXRvcnkgd2hlbiB0eXBlIGlzICdjaGlsZCdcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgKS50aGVuKHJlc3VsdCA9PiB7XHJcblxyXG5cclxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgIFxuICAgICAgICB9KS5zaGFyZSgpO1xuICAgIH1cblxyXG59Il19